# éšæ®µ 1: ç·¨è­¯ (Build Stage)
FROM node:18-alpine AS build-stage
WORKDIR /app

# å…ˆè¤‡è£½ package.json ä»¥åˆ©ç”¨ Docker Layer Cache ç¸®çŸ­ build time
COPY package*.json ./
# ğŸ’¡ å®‰è£ä¾è³´ï¼Œfrozen-lockfile ç¢ºä¿ç‰ˆæœ¬ä¸€è‡´æ€§
RUN npm install --frozen-lockfile

# è¤‡è£½æ‰€æœ‰åŸå§‹ç¢¼ä¸¦åŸ·è¡Œ Vite ç·¨è­¯
COPY . .
RUN npm run build

# éšæ®µ 2: Nginx é‹è¡Œ (Production Stage)
FROM nginx:stable-alpine AS production-stage
WORKDIR /usr/share/nginx/html

# ğŸ’¡ å¾ç·¨è­¯éšæ®µå°‡ç”¢å‡ºçš„éœæ…‹æª”æ¡ˆ (dist) è¤‡è£½éä¾†
COPY --from=build-stage /app/dist .

# ğŸ’¡ æ³¨å…¥è‡ªå®šç¾© Nginx é…ç½® (é€™ä¸€æ­¥æœ€é—œéµï¼Œæ±ºå®šäº† /api èƒ½å¦é€šå¾€å¾Œç«¯)
COPY nginx/default.conf /etc/nginx/conf.d/default.conf

EXPOSE 80

# å»ºç«‹å¥åº·æª¢æŸ¥æ©Ÿåˆ¶
HEALTHCHECK --interval=15s --timeout=10s --retries=3 \
    CMD wget -qO- http://localhost:80/ || exit 1 

CMD ["nginx", "-g", "daemon off;"]