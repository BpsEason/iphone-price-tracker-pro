# --- Stage 1: Builder ---
FROM python:3.12-slim AS builder

ENV UV_PROJECT_ENVIRONMENT=/opt/venv \
    UV_COMPILE_BYTECODE=1 \
    UV_LINK_MODE=copy

WORKDIR /app

RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    libpq-dev \
    && rm -rf /var/lib/apt/lists/*

COPY --from=ghcr.io/astral-sh/uv:latest /uv /uvx /bin/
COPY pyproject.toml uv.lock ./
RUN uv sync --frozen --no-cache --no-dev

# --- Stage 2: Final ---
FROM python:3.12-slim
WORKDIR /app

# å»ºç«‹é root å¸³è™Ÿ (ä½¿ç”¨å›ºå®š UID/GID 1000 ä»¥åˆ©æ–¼æ¬Šé™ç®¡ç†)
RUN groupadd -g 1000 appuser && \
    useradd -u 1000 -g appuser -m -s /bin/bash appuser

# å®‰è£é‹è¡Œæ™‚å¿…è¦çš„åº«èˆ‡å·¥å…·
RUN apt-get update && apt-get install -y --no-install-recommends \
    libpq5 \
    curl \
    dnsutils \
    iputils-ping \
    && rm -rf /var/lib/apt/lists/*

# è¤‡è£½è™›æ“¬ç’°å¢ƒ
COPY --from=builder /opt/venv /opt/venv

# è¨­å®šç’°å¢ƒè®Šæ•¸
ENV PATH="/opt/venv/bin:$PATH" \
    PYTHONUNBUFFERED=1 \
    TZ=Asia/Taipei \
    PYTHONDONTWRITEBYTECODE=1

# ğŸ’¡ é—œéµä¿®æ­£ï¼šç¢ºä¿ logs ç›®éŒ„å­˜åœ¨ä¸”æ¬Šé™æ­£ç¢º
# åŒæ™‚ç¢ºä¿å®¿ä¸»æ©Ÿæ›è¼‰é»çš„çˆ¶ç›®éŒ„ä¹Ÿæ˜¯æ­£ç¢ºçš„æ“æœ‰è€…
RUN mkdir -p /app/logs && chown -R appuser:appuser /app/logs

# ä½¿ç”¨ --chown ç¢ºä¿ä»£ç¢¼æª”æ¡ˆå±¬æ–¼ appuser
COPY --chown=appuser:appuser . .

# ä¿®æ­£ entrypoint æ¬Šé™
RUN chmod +x entrypoint.sh && chown appuser:appuser entrypoint.sh

# åˆ‡æ›åˆ°é root ä½¿ç”¨è€…
USER appuser

ENTRYPOINT ["./entrypoint.sh"]